{
  "code": "import GameConfig from \"./GameConfig\";\r\nimport { AppConfig } from \"./AppConfig\";\r\nimport Log from \"./utils/Log\";\r\nimport { getVersionSettings } from \"./utils/Setting\";\r\nimport { ShareType } from \"./utils/Share\";\r\nimport { insertCount } from \"./utils/Count\";\r\nimport PageRoot from \"./page/RootPage\";\r\nimport UiManager from \"./UiManager\";\r\nimport LoadPage from \"./page/LoadPage\";\r\nclass Main {\r\n    constructor() {\r\n        Main.app = this;\r\n        Config.isAntialias = true;\r\n        box2d.DEBUG = AppConfig.DEBUG;\r\n        Laya.init(GameConfig.width, GameConfig.height, Laya[\"WebGL\"]);\r\n        Laya.stage.scaleMode = GameConfig.scaleMode;\r\n        Laya.stage.screenMode = GameConfig.screenMode;\r\n        Laya.Physics.enable();\r\n        Laya.URL.exportSceneToJson = GameConfig.exportSceneToJson;\r\n        if (AppConfig.isWX) {\r\n            wx.cloud.init({\r\n                env: AppConfig.APP_ID\r\n            });\r\n            this.login();\r\n            AppConfig.userId = AppConfig.userData.userId;\r\n            AppConfig.systemInfo = wx.getSystemInfoSync();\r\n            Log.d(\"手机信息：\");\r\n            Log.d(AppConfig.systemInfo);\r\n            AppConfig.scaleX = AppConfig.systemInfo.windowWidth / GameConfig.width;\r\n            Log.d(AppConfig.scaleX);\r\n            AppConfig.screenH = AppConfig.systemInfo.screenHeight / AppConfig.scaleX;\r\n            getVersionSettings();\r\n            this.initWx();\r\n        }\r\n        Log.d(AppConfig.screenH);\r\n        if (AppConfig.screenH >= 2300) {\r\n            AppConfig.IPHONEX_BOTTOM = AppConfig.IPHONEX_BOTTOM * AppConfig.scaleX;\r\n        }\r\n        else {\r\n            AppConfig.IPHONEX_BOTTOM = 0;\r\n        }\r\n        Log.d(\"距离底部高度：\" + AppConfig.IPHONEX_BOTTOM);\r\n        this.onBgImageLoaded();\r\n    }\r\n    login() {\r\n        let thiz = this;\r\n        AppConfig.userChannel = wx.getStorageSync(AppConfig.USERCHANNEL);\r\n        if (!AppConfig.userChannel || AppConfig.userChannel == '') {\r\n            var data = wx.getLaunchOptionsSync();\r\n            if (data.query && data.query.channel) {\r\n                AppConfig.userChannel = data.query.channel;\r\n                wx.setStorage({\r\n                    key: AppConfig.USERCHANNEL,\r\n                    data: AppConfig.userChannel\r\n                });\r\n            }\r\n        }\r\n        if (AppConfig.userData.userId != null && AppConfig.userData.userId.length > 5) {\r\n            return;\r\n        }\r\n        AppConfig.userData.userId = wx.getStorageSync(AppConfig.OPENID);\r\n        if (AppConfig.userData.userId != null && AppConfig.userData.userId.length > 5) {\r\n            return;\r\n        }\r\n        wx.cloud.callFunction({\r\n            name: 'login',\r\n        }).then(res => {\r\n            var openId = res.result.openid;\r\n            if (openId) {\r\n                AppConfig.userData.userId = openId;\r\n                insertCount({ userId: AppConfig.userData.userId, type: '登录成功', });\r\n                wx.setStorage({ key: AppConfig.OPENID, data: openId });\r\n                wx.setStorage({ key: AppConfig.USERDATA, data: AppConfig.userData });\r\n            }\r\n            Log.d('云函数  登录  ：' + openId);\r\n        }).catch(err => {\r\n            insertCount({ userId: AppConfig.userData.userId, type: '登录失败', });\r\n            Log.d('登录失败：' + err);\r\n        });\r\n    }\r\n    onBgImageLoaded() {\r\n        Main.pageRoot = new PageRoot(AppConfig.screenW, AppConfig.screenH);\r\n        Log.d('screenH:' + AppConfig.screenH);\r\n        Laya.stage.addChild(Main.pageRoot);\r\n        UiManager.getSelf().setRootPage(Main.pageRoot);\r\n        UiManager.getSelf().addPage(LoadPage.getSelf());\r\n        LoadPage.getSelf().loadRes(this.onSubpackageLoaded);\r\n    }\r\n    onSubpackageLoaded(flag) {\r\n        Log.d('分包加载完成::::' + flag);\r\n        let thiz = Main.app;\r\n        if (flag) {\r\n            Laya.loader.load(\"level/tip.json\", Laya.Handler.create(thiz, function (res) {\r\n                Log.d(res);\r\n                if (res && res.length > 0) {\r\n                    AppConfig.levelCutSteps = res;\r\n                    AppConfig.maxLevel = AppConfig.levelCutSteps.length;\r\n                    AppConfig.totalGrade = Math.ceil(AppConfig.maxLevel / AppConfig.GRADE_COUNT);\r\n                }\r\n            }), null, Laya.Loader.JSON);\r\n            let resPath = \"res/atlas/comp.atlas\";\r\n            Laya.loader.load([resPath], Laya.Handler.create(thiz, thiz.onAssetsLoaded), null, Laya.Loader.ATLAS);\r\n        }\r\n        else {\r\n            UiManager.getSelf().showModal({\r\n                content: \"资源加载失败，是否重试？\",\r\n                showCancel: true,\r\n                confirmText: \"重载\",\r\n                success: res => {\r\n                    if (res.confirm) {\r\n                        LoadPage.getSelf().loadRes(thiz.onSubpackageLoaded);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n    onAssetsLoaded() {\r\n        Log.d('资源加载完成::::');\r\n        LoadPage.getSelf().destroy();\r\n        Main.pageRoot.topLayout.visible = true;\r\n        UiManager.getSelf().goHome();\r\n    }\r\n    initWx() {\r\n        if (!AppConfig.isWX)\r\n            return;\r\n        AppConfig.isMute = wx.getStorageSync(AppConfig.ISMUTE);\r\n        AppConfig.isMuteBgm = AppConfig.isMute;\r\n        let cacheUserData = wx.getStorageSync(AppConfig.USERDATA);\r\n        if (cacheUserData && cacheUserData.level) {\r\n            AppConfig.userData.level = cacheUserData.level;\r\n        }\r\n        wx.showShareMenu({\r\n            withShareTicket: true\r\n        });\r\n        var thiz = this;\r\n        if (AppConfig.ifAldShare) {\r\n            wx.aldOnShareAppMessage(function () {\r\n                var tmp_query = '';\r\n                tmp_query = 'uid=' + AppConfig.userId + '&state=' + ShareType.MENU;\r\n                Log.d('右上角转发~~~');\r\n                Log.d('右上角转发~~~');\r\n                Log.d(tmp_query);\r\n                return {\r\n                    query: tmp_query,\r\n                    title: '据说只有1%的人能过关，是你吗？',\r\n                    imageUrl: AppConfig.LOCAL_SHARE,\r\n                };\r\n            });\r\n        }\r\n        else {\r\n            wx.onShareAppMessage(function () {\r\n                var tmp_query = '';\r\n                tmp_query = 'uid=' + AppConfig.userId + '&state=' + ShareType.MENU;\r\n                Log.d('右上角转发~~~');\r\n                Log.d(tmp_query);\r\n                return {\r\n                    query: tmp_query,\r\n                    title: '据说只有1%的人能过关，是你吗？',\r\n                    imageUrl: AppConfig.LOCAL_SHARE,\r\n                };\r\n            });\r\n        }\r\n    }\r\n    static getApp() {\r\n        return Main.app;\r\n    }\r\n}\r\nMain.app = null;\r\nMain.pageRoot = null;\r\nvar app = new Main();\r\n",
  "references": [
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/GameConfig.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/AppConfig.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/utils/Log.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/utils/Setting.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/utils/Share.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/utils/Count.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/page/RootPage.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/UiManager.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/page/LoadPage.ts"
  ]
}
