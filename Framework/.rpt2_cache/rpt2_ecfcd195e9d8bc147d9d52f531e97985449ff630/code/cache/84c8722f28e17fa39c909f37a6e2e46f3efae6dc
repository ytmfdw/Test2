{
  "code": "import { AppConfig } from \"../AppConfig\";\r\nimport Log from \"./Log\";\r\nimport { insertCount } from \"./Count\";\r\nexport function shareToFriend(msg, query) {\r\n    AppConfig.shareCancel = false;\r\n    var state = getState(query);\r\n    switch (state) {\r\n        case ShareType.BONUS:\r\n            {\r\n                AppConfig.isShareBonus = true;\r\n            }\r\n            break;\r\n        case ShareType.SHOWTIP:\r\n            {\r\n                AppConfig.isShareTip = true;\r\n            }\r\n            break;\r\n        case ShareType.GROUP:\r\n            {\r\n                AppConfig.isShareGroup = true;\r\n            }\r\n            break;\r\n    }\r\n    var imgId = 'none';\r\n    var link = 'imgId=';\r\n    var shared = getShared(query);\r\n    var imgPath = AppConfig.LOCAL_SHARE;\r\n    var title = \"这条狗要治，上天了都...\";\r\n    if (shared) {\r\n        if (shared.imgs) {\r\n            var rand = Math.random();\r\n            var data = null;\r\n            var len = shared.imgs.length;\r\n            for (var i = 0; i < len; i++) {\r\n                var tmp = shared.imgs[i];\r\n                if (rand >= tmp.min && rand < tmp.max) {\r\n                    if (data && data.max < tmp.max) {\r\n                        data = tmp;\r\n                    }\r\n                    else {\r\n                        data = tmp;\r\n                    }\r\n                }\r\n            }\r\n            if (!data) {\r\n                data = shared.imgs[0];\r\n            }\r\n            imgPath = data.url;\r\n            title = data.title;\r\n            imgId = data.id;\r\n            link = data.link ? data.link : imgId = ' + imgId';\r\n            Log.d(data);\r\n        }\r\n        else if (shared.sharedImg) {\r\n            imgPath = shared.sharedImg[0];\r\n            title = shared.sharedTitle[0];\r\n            link = 'imgId=' + imgId;\r\n        }\r\n    }\r\n    else {\r\n        link = '';\r\n    }\r\n    if (!AppConfig.ifShowBonus) {\r\n        imgPath = AppConfig.LOCAL_SHARE;\r\n        title = \"这条狗要治，上天了都...\";\r\n    }\r\n    if (msg) {\r\n        title = msg;\r\n    }\r\n    var newQuery = query ? query : ('uid=' + AppConfig.userId + '&state=0');\r\n    newQuery = link + '&' + newQuery;\r\n    AppConfig.getShareTime = new Date().getTime();\r\n    if (AppConfig.ifAldShare) {\r\n        wx.aldShareAppMessage({\r\n            query: newQuery,\r\n            imageUrl: imgPath,\r\n            title: title,\r\n            fail: () => {\r\n                AppConfig.shareCancel = true;\r\n            }\r\n        });\r\n    }\r\n    else {\r\n        wx.shareAppMessage({\r\n            query: newQuery,\r\n            imageUrl: imgPath,\r\n            title: title,\r\n            fail: () => {\r\n                AppConfig.shareCancel = true;\r\n            }\r\n        });\r\n    }\r\n    setTimeout(function () {\r\n        Log.d('update updateShareMenu withShareTicket');\r\n        wx.updateShareMenu({\r\n            withShareTicket: false\r\n        });\r\n    }, 1500);\r\n}\r\nexport function getState(query) {\r\n    if (query) {\r\n        var result = /state=(\\d+)/.exec(query);\r\n        if (result && result.length > 1) {\r\n            return parseInt(result[1]);\r\n        }\r\n    }\r\n    return 0;\r\n}\r\nexport function getShared(query) {\r\n    var state = 0;\r\n    state = getState(query);\r\n    Log.d('得到state=' + state);\r\n    var sharedContent = wx.getStorageSync(AppConfig.SHARED_KEY);\r\n    if (typeof sharedContent == 'undefined') {\r\n        return null;\r\n    }\r\n    var len = sharedContent.length;\r\n    for (var i = 0; i < len; i++) {\r\n        if (sharedContent[i].sharedType == state) {\r\n            return sharedContent[i];\r\n        }\r\n    }\r\n}\r\nexport function shareError(state, level, ifCancel) {\r\n    var query = 'uid=' + AppConfig.userId + '&token=' + new Date().getTime() + '&level=' + level + '&state=' + state;\r\n    var msg = ifCancel ? '您刚刚取消了分享，请分享到群！' : '分享失败，请分享到不同的群!';\r\n}\r\nexport function shareSuccess(state, level) {\r\n    insertCount({ userId: AppConfig.userId, type: state == ShareType.BONUS ? '分享链接点击成功 获得金币' : (state == ShareType.SHOWTIP ? '分享链接点击成功 获得提示' : '分享链接点击成功 拆开红包'), mark: 'userId:' + AppConfig.userId + '；level:' + (Main.getApp().uiManager.gamePage ? Main.getApp().uiManager.gamePage.level : -1) });\r\n}\r\nexport const ShareType = {\r\n    HOME: 1,\r\n    PASS: 6,\r\n    GROUP: 4,\r\n    BONUS: 5,\r\n    SHOWTIP: 10,\r\n    MENU: 9\r\n};\r\n",
  "references": [
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/AppConfig.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/utils/Log.ts",
    "E:/game/Growup/Laya2Framework/Framework/Framework/src/utils/Count.ts"
  ]
}
